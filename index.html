<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />

    <script src="https://cdn.jsdelivr.net/npm/vega@5.30.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.21.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.26.0"></script>

    <style>
      html {
        color-scheme: dark;
      }
      #vis {
        width: 95vw;
        height: 95vh;
      }
      canvas {
        cursor: grab;
      }
      .vega-actions a {
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <div id="vis"></div>

    <script>
      (async () => {



      raw = await (await fetch('https://raw.githubusercontent.com/lukaw3d/oasis-nexus-consensus-delayed/main/log.json')).text()
      data = JSON.parse('[' + raw.trim().split('\n').join(',') + ']');
      data.forEach(a => a['latest_block_time_age_min'] = Math.max(a.latest_block_time_age_ms/60000, 0))
      data2 = data.map(a=> [a.request_time, a.latest_block_time_age_ms/60000]);

      vlSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": "container",
        "height": "container",
        "data": {values: data},
        "encoding": {
          "x": {
            "field": "request_time",
            "type": "temporal",
          },
        },
        "layer": [
          {
            "mark": {"type": "line", "color": "#85A9C5"},
            "encoding": {
              "y": {
                "field": "latest_block_time_age_min",
                "type": "quantitative",
                "title": "Last block _ minutes ago",
                "axis": {"titleColor": "#85A9C5"}
              },
            },
          },
          {
            "params": [{
              "name": "grid",
              "select": {"type": "interval", "encodings": ["x"]},
              "bind": "scales"
            }],
            "mark": {"type": "line", point: {fill: '#85C5A6'}, strokeDash: [1, 8], "color": "#85C5A6"},
            "encoding": {
              "y": {
                "field": "latest_node_block_diff",
                "type": "quantitative",
                "title": "# Blocks behind node",
                "axis": {"titleColor": "#85C5A6"}
              },
            },
          },
        ],
        "resolve": {"scale": {"y": "independent"}},
      }

      vegaEmbed('#vis', vlSpec, {theme: 'dark'});
      })();
    </script>
  </body>
</html>
